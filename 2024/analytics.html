<!DOCTYPE html>
<html lang="en">
<head>
   
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>starly dot dev - My Adventure in Building Umami</title>
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:site" content="starly.dev" />
        
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://starly.dev/2024/analytics.html" />
        <meta property="og:title" content="My Adventure in Building Umami" />
        <meta name="twitter:title" content="My Adventure in Building Umami" />
        <meta property="og:description" content="<p>How I set up website analytics tracking with Umami</p>" />
        <meta name="twitter:description" content="<p>How I set up website analytics tracking with Umami</p>" />
        <meta property="og:image" content="https://starly.dev/extra/og-default.png" />
        <meta name="twitter:image" content="https://starly.dev/extra/og-default.png" />
   
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"/>
        <link rel="stylesheet" type="text/css" href="https://starly.dev/theme/css/main.css"/>

<meta name="tags" content="misc" />
</head>
<body>
<style>.github-corner:hover .octo-arm {
    animation: octocat-wave 560ms ease-in-out
}
@keyframes octocat-wave {
    0%, 100% {
        transform: rotate(0)
    }
    20%, 60% {
        transform: rotate(-25deg)
    }
    40%, 80% {
        transform: rotate(10deg)
    }
}
@media (max-width: 500px) {
    .github-corner:hover .octo-arm {
        animation: none
    }

    .github-corner .octo-arm {
        animation: octocat-wave 560ms ease-in-out
    }
}</style><div id="container">
    <header>
        <h1><a href="https://starly.dev/">starly dot dev</a></h1>
            <ul class="social-media">
                    <li><a href="https://github.com/mr4tt" target="_blank" data-umami-event="fa-brands fa-github"><i class="fa-brands fa-github" aria-hidden="true"></i></a></li>
                    <li><a href="mailto:hello.mrat@gmail.com" target="_blank" data-umami-event="fa-regular fa-envelope"><i class="fa-regular fa-envelope" aria-hidden="true"></i></a></li>
            </ul>
        <p><em></em></p>
    </header>
    <nav>
        <ul>
                    <li><a href="https://starly.dev/category/comics.html" data-umami-event="Comics">Comics</a></li>
                    <li><a  class="active" href="https://starly.dev/category/misc.html" data-umami-event="Misc">Misc</a></li>
                    <li><a href="https://starly.dev/category/portfolio.html" data-umami-event="Portfolio">Portfolio</a></li>
                    <li><a href="https://starly.dev/pages/about-me.html" data-umami-event="About Me">About Me</a></li>
        </ul>
    </nav>
<main>
    <article>
        <h1>My Adventure in Building Umami</h1>
        
        <aside>
            <ul>
                <li>
                    <time datetime="2024-04-05 19:37:00-07:00">Apr 05, 2024</time>
                </li>
                <!--  -->
                <li>
                    Categories:
                    <a href="https://starly.dev/category/misc.html"><em>Misc</em></a>
                </li>
                <li>
                    Tags:
                    <a href="https://starly.dev/tag/misc.html"><em>#misc</em></a>
                </li>
            </ul>
        </aside>
        <script src="https://starly.dev/2024/nutshelldev.js"></script>
<script>
Nutshell.setOptions({
    dontEmbedHeadings: true, // If 'true', removes the "embed this as a nutshell" option on headings
});
</script>

<!-- ---

I'll be testing [Nutshell](https://github.com/ncase/nutshell) out! When you see a link like [:this](#note1), click on it to expand it.

--- -->

<p><a href="https://umami.is/">Umami</a>. is an open source analytics provider focused on privacy. This means you can see information about people who visit your website, like their country. </p>
<p>You can find Starly's analytics dashboard <a href="https://umami.starly.dev/share/hNfhWdonj5bA5dBj/starly.dev">here</a> !</p>
<hr>
<p>Google Analytics does similar things, but I didn't need a lot of their advanced features (who would have thought my tiny blog wouldn't need ad revenue tracking). And lack of privacy and GDPR non-compliant or something. </p>
<p>There's other Google Analytics alternatives, but they cost money, so I didn't read much of their websites. </p>
<p>If you're just here to figure out installing Umami without any extra bits, you'll be fine following only the bullet points. </p>
<hr>
<h2>Software Requirements</h2>
<ul>
<li>i am using Ubuntu 23.10 on a Digital Ocean instance</li>
<li>install Node.js, <a class="blue-link" href="https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-22-04">tutorial</a></li>
<li>install Nginx, <a class="blue-link" href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-22-04">tutorial</a></li>
<li>install PostgreSQL, <a class="blue-link" href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-ubuntu-22-04">tutorial</a><ul>
<li>you can also use MySQL with Umami, but this post uses postgres</li>
</ul>
</li>
</ul>
<p>actual install docs from umami are <a href="https://umami.is/docs/install">here</a></p>
<h2>Steps to install and run Umami</h2>
<ol>
<li>
<p><strong>set up yarn</strong></p>
<ul>
<li>run <code>corepack enable</code></li>
</ul>
<p>We use Yarn (package manager, similar to npm) to install necessary packages. This is activated with corepack, which comes with our Node.js installation. </p>
<p>For more info, yarn installation docs are <a class="blue-link" href="https://yarnpkg.com/getting-started/install">here</a></p>
</li>
<li>
<p><strong>set up umami</strong></p>
<ul>
<li><code>git clone https://github.com/umami-software/umami.git</code></li>
<li><code>cd umami</code></li>
<li><code>yarn</code></li>
</ul>
<p>To set up Umami, clone the repo and run <code>yarn</code> inside, which looks at the <code>package.json</code> file in the repo and downloads the packages specified there. </p>
</li>
<li>
<p><strong>set up postgres and connection string</strong></p>
<ul>
<li>run <code>createdb --username=postgres --host=localhost umami</code></li>
<li>create a <code>.env</code> file in the cloned umami folder</li>
<li>put this line in <code>.env</code>, filling in your Postgres's details: <code>DATABASE_URL=postgresql://[USERNAME]:[PASSWORD]@[DB_LOCATION]:[PORT]/[DATABASE_NAME]</code></li>
</ul>
<p>Use the <code>createdb</code> command to create a databse called umami. Then, put your connection string into a new <code>.env</code> file so Umami knows how to connect to your Postgres instance and which database to put the metrics in. </p>
<p>my <a href="#postgresNote1">:example string</a>.</p>
<p>Note: If you've installed postgres for the first time, you may want to make another user besides the default (postgres), set a password, or change authentication methods.</p>
</li>
<li>
<p><strong>build Umami</strong></p>
<ul>
<li><code>yarn build</code></li>
<li>some optional things:<ul>
<li><code>yarn next telemetry disable</code> to disable Next.js telemetry</li>
<li>to change the port next.js uses (default is 3000), go to <code>package.json</code>, change <code>next start</code> to be <code>next start -p [new port]</code></li>
</ul>
</li>
</ul>
<p>Running <code>yarn build</code> looks at the <code>scripts</code> section of <code>package.json</code> and executes the commands found under <code>build</code>.</p>
<p>Note: Building eats a lot of memory and the base Digital Ocean server may not have enough memory to run it without upgrading or configuring more swap (I learned the hard way!). </p>
<p><a href="#swap">:More about swap</a></p>
</li>
<li>
<p><strong>start Umami</strong></p>
<ul>
<li>run <code>npm start</code></li>
<li>go to <code>http://[IP]:3000/</code></li>
<li>log in:<ul>
<li>username: admin</li>
<li>password: umami</li>
</ul>
</li>
<li>go to settings to change your password</li>
</ul>
<p>Optional: use <a href="https://pm2.keymetrics.io/docs/usage/quick-start/">PM2</a>, a process manager, to manage your Umami instance. This makes it easier to start and stop Umami when it stops running, like when you restart your server. </p>
<ul>
<li><code>npm install pm2 -g</code></li>
<li><code>pm2 start npm --name umami -- start</code><ul>
<li>make sure you're in the umami folder before running</li>
</ul>
</li>
<li><code>pm2 save</code></li>
</ul>
<p>These steps install PM2 globally, start the Umami instance, and saves it in a list that you can easily restart later.</p>
</li>
<li>
<p><strong>set up site</strong></p>
<ul>
<li>in Umami, go to Settings &gt; Websites</li>
<li>click Add Website<ul>
<li>name: can be anything you want (eg: starly)</li>
<li>domain: your website domain (eg: starly.dev)</li>
</ul>
</li>
<li>click edit &gt; tracking code <ul>
<li>copy tracking code and put it somewhere in the <code>&lt;head&gt;...&lt;/head&gt;</code> tag of your website</li>
</ul>
</li>
<li>optional:<ul>
<li>edit &gt; enable share URL if you'd like to share the dashboard</li>
</ul>
</li>
<li>test by going to your website and seeing if the visitor count goes up</li>
</ul>
<p>If you don't want to track your own visits to your website, you can add <code>umami.disabled</code> with a value of <code>1</code>.</p>
<p><a href="#disable">:How?</a></p>
</li>
</ol>
<hr>
<p>There's other things to play around with like reports and insights, but I haven't gotten around to it yet. </p>
<p>At this point, you're done setting Umami up and have reliable metrics about your website! </p>
<hr>
<p>One other thing I did was set up umami.starly.dev as the domain to send Umami requests to (proxying). 
If your website is hosted on the same server that you're running Umami on, you </p>
<ol>
<li></li>
</ol>
<h2>How does it work?</h2>
<p><code>&lt;script defer="" src="https://umami.starly.dev/script.js" data-website-id="really-cool-string"&gt;&lt;/script&gt;</code></p>
<p>This calls <a href="https://github.com/umami-software/umami/blob/88da20ea7f9e34a3d09cf8503ae09bff63b254bc/src/tracker/index.js"><code>script.js</code></a>, which in turn does some stuff i guess idk </p>
<p>test
<kbd> hi </kbd></p>
<h2>:x note1</h2>
<p>hi!</p>
<h2>:x postgresNote1</h2>
<p><code>DATABASE_URL=postgresql://username:password@localhost:5432/umami</code></p>
<h2>:x swap</h2>
<p>Swap is hard drive space used as RAM. Although it is much slower than actual RAM, it can be used when you run out of actual RAM. However, it will slow your system down a lot. </p>
<p>The following commands let you configure swap on your server, where count is the amount of memory you'd like to use for swapping. </p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>/bin/dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/var/swap.1<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">1024</span>
sudo<span class="w"> </span>/sbin/mkswap<span class="w"> </span>/var/swap.1
sudo<span class="w"> </span>/sbin/swapon<span class="w"> </span>/var/swap.1
</code></pre></div>

<ul>
<li>First command makes a file in <code>/var</code> called <code>swap.1</code> with 1024mb filled with 0s (basically just allocating space for the file).</li>
<li>Second command formats the swap.1 file as a swap area. </li>
<li>Third command tells the OS you'd like to start using the swap space</li>
</ul>
<p>This change will not be permanent unless you add this info to your /etc/fstab file. </p>
<p>More info <a href="https://www.digitalocean.com/community/tutorials/how-to-add-swap-space-on-ubuntu-22-04">here</a></p>
<h2>:x disable</h2>
<ol>
<li>go to your website and inspect element</li>
<li>go to the Application tab </li>
<li>go to Cookies</li>
<li>double click the next available space below <code>Name</code> and type <code>umami.disabled</code></li>
<li>add a value to it of <code>1</code></li>
</ol>
    </article>
    <section class="post-nav">
        <div id="left-page">
            <div id="left-link">
            </div>
        </div>
        <div id="right-page">
            <div id="right-link">
            </div>
        </div>
    </section>
    <div>
    </div>
</main>
    <footer>
        <h6>
            Rendered by <a href="http://getpelican.com/">Pelican</a> &nbsp;&bull;&nbsp; Theme by <a href="https://github.com/aleylara/Peli-Kiera">Peli-Kiera</a> 
            &nbsp;&bull;&nbsp;   By mrat         </h6>
    </footer>
</div>
</body>
</html>
